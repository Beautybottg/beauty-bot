#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import logging
import json
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Tuple

from telegram import (
    Update, 
    InlineKeyboardButton, 
    InlineKeyboardMarkup,
    ReplyKeyboardMarkup,
    KeyboardButton
)
from telegram.ext import (
    Application, 
    CommandHandler, 
    CallbackQueryHandler, 
    MessageHandler, 
    ContextTypes,
    ConversationHandler,
    filters
)
from telegram.constants import ParseMode

# ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
TOKEN = "–í–ê–®_–¢–û–ö–ï–ù_–û–¢_BOTFATHER"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω!
ADMIN_IDS = [123456789]  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (—É–∑–Ω–∞—Ç—å —á–µ—Ä–µ–∑ @userinfobot)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è ConversationHandler
SELECT_SERVICE, SELECT_DATE, SELECT_TIME, ENTER_NAME, ENTER_PHONE, ENTER_COMMENT, CONFIRMATION = range(7)
CANCEL_APPOINTMENT = 8

# ========== –ë–ê–ó–ê –î–ê–ù–ù–´–• (–ø—Ä–æ—Å—Ç–∞—è JSON) ==========
DB_FILE = "appointments.json"

def load_appointments() -> Dict:
    """–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø–∏—Å–µ–π –∏–∑ —Ñ–∞–π–ª–∞"""
    try:
        with open(DB_FILE, 'r', encoding='utf-8') as f:
            return json.load(f)
    except (FileNotFoundError, json.JSONDecodeError):
        return {"appointments": {}, "counters": {"next_id": 1}}

def save_appointments(data: Dict):
    """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –≤ —Ñ–∞–π–ª"""
    with open(DB_FILE, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

def add_appointment(appointment: Dict) -> int:
    """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏"""
    data = load_appointments()
    appointment_id = data["counters"]["next_id"]
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è
    appointment["created_at"] = datetime.now().isoformat()
    appointment["status"] = "active"  # active, cancelled, completed
    
    data["appointments"][str(appointment_id)] = appointment
    data["counters"]["next_id"] += 1
    
    save_appointments(data)
    return appointment_id

def get_user_appointments(user_id: int) -> List[Tuple[int, Dict]]:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    data = load_appointments()
    user_appointments = []
    
    for app_id, appointment in data["appointments"].items():
        if str(user_id) in appointment.get("user_id", ""):
            user_appointments.append((int(app_id), appointment))
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ
    user_appointments.sort(key=lambda x: x[1].get("date", ""))
    return user_appointments

def cancel_appointment(appointment_id: int, cancelled_by: str = "client") -> bool:
    """–û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏"""
    data = load_appointments()
    
    if str(appointment_id) in data["appointments"]:
        appointment = data["appointments"][str(appointment_id)]
        appointment["status"] = "cancelled"
        appointment["cancelled_at"] = datetime.now().isoformat()
        appointment["cancelled_by"] = cancelled_by
        save_appointments(data)
        return True
    
    return False

def get_appointment(appointment_id: int) -> Optional[Dict]:
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –ø–æ ID"""
    data = load_appointments()
    return data["appointments"].get(str(appointment_id))

# ========== –£–°–õ–£–ì–ò –ò –†–ê–°–ü–ò–°–ê–ù–ò–ï ==========
SERVICES = {
    "manicure": {
        "name": "üíÖ –ú–∞–Ω–∏–∫—é—Ä",
        "price": "1500-2500 —Ä—É–±",
        "duration": "60-90 –º–∏–Ω",
        "description": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π, –∞–ø–ø–∞—Ä–∞—Ç–Ω—ã–π, –ø–æ–∫—Ä—ã—Ç–∏–µ –≥–µ–ª—å-–ª–∞–∫–æ–º"
    },
    "pedicure": {
        "name": "ü¶∂ –ü–µ–¥–∏–∫—é—Ä",
        "price": "2000-3000 —Ä—É–±",
        "duration": "90-120 –º–∏–Ω",
        "description": "–ê–ø–ø–∞—Ä–∞—Ç–Ω—ã–π, –µ–≤—Ä–æ–ø–µ–π—Å–∫–∏–π, –º—É–∂—Å–∫–æ–π"
    },
    "eyelash": {
        "name": "üëÅÔ∏è –ù–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ —Ä–µ—Å–Ω–∏—Ü",
        "price": "2500-4000 —Ä—É–±",
        "duration": "120-180 –º–∏–Ω",
        "description": "–ö–ª–∞—Å—Å–∏–∫–∞, 2D, 3D, –æ–±—ä–µ–º–Ω–æ–µ –Ω–∞—Ä–∞—â–∏–≤–∞–Ω–∏–µ"
    },
    "brows": {
        "name": "‚úèÔ∏è –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –±—Ä–æ–≤–µ–π",
        "price": "800-1500 —Ä—É–±",
        "duration": "30-60 –º–∏–Ω",
        "description": "–ö–æ—Ä—Ä–µ–∫—Ü–∏—è, –æ–∫—Ä–∞—à–∏–≤–∞–Ω–∏–µ, –ª–∞–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
    },
    "facial": {
        "name": "üå∏ –ß–∏—Å—Ç–∫–∞ –ª–∏—Ü–∞",
        "price": "1800-3500 —Ä—É–±",
        "duration": "60-90 –º–∏–Ω",
        "description": "–ú–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∞—è, —É–ª—å—Ç—Ä–∞–∑–≤—É–∫–æ–≤–∞—è, –∞—Ç—Ä–∞–≤–º–∞—Ç–∏—á–Ω–∞—è"
    },
    "haircut": {
        "name": "üíá –°—Ç—Ä–∏–∂–∫–∞",
        "price": "1200-2500 —Ä—É–±",
        "duration": "60 –º–∏–Ω",
        "description": "–ñ–µ–Ω—Å–∫–∞—è, –º—É–∂—Å–∫–∞—è, –¥–µ—Ç—Å–∫–∞—è —Å—Ç—Ä–∏–∂–∫–∞"
    },
    "makeup": {
        "name": "üíÑ –ú–∞–∫–∏—è–∂",
        "price": "2000-4000 —Ä—É–±",
        "duration": "60-90 –º–∏–Ω",
        "description": "–î–Ω–µ–≤–Ω–æ–π, –≤–µ—á–µ—Ä–Ω–∏–π, —Å–≤–∞–¥–µ–±–Ω—ã–π"
    }
}

# –î–æ—Å—Ç—É–ø–Ω–æ–µ –≤—Ä–µ–º—è
TIME_SLOTS = [
    "09:00", "10:30", "12:00", "13:30", 
    "15:00", "16:30", "18:00", "19:30"
]

# ========== –ö–û–ú–ê–ù–î–´ –ë–û–¢–ê ==========
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    user = update.effective_user
    
    welcome_text = f"""
‚ú® *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.first_name}!* ‚ú®

–Ø ‚Äî –±–æ—Ç —Å–∞–ª–æ–Ω–∞ –∫—Ä–∞—Å–æ—Ç—ã *Beauty Elegance* üè©

*–ß—Ç–æ —è —É–º–µ—é:*
‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å –Ω–∞ —É—Å–ª—É–≥—É
üìã –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–∏ –∑–∞–ø–∏—Å–∏
‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å
üìû –°–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º

*–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:*"""

    keyboard = [
        [InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —É—Å–ª—É–≥—É", callback_data="new_appointment")],
        [InlineKeyboardButton("üìã –ú–æ–∏ –∑–∞–ø–∏—Å–∏", callback_data="my_appointments")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å", callback_data="cancel_appointment")],
        [InlineKeyboardButton("üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã", callback_data="contacts")],
        [InlineKeyboardButton("‚ÑπÔ∏è –û —Å–∞–ª–æ–Ω–µ", callback_data="about")]
    ]
    
    if user.id in ADMIN_IDS:
        keyboard.append([InlineKeyboardButton("üëë –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_panel")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(
        welcome_text, 
        reply_markup=reply_markup,
        parse_mode=ParseMode.MARKDOWN
    )
    
    return ConversationHandler.END

async def new_appointment(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏ –Ω–∞ —É—Å–ª—É–≥—É"""
    query = update.callback_query
    await query.answer()
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    context.user_data.clear()
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä —É—Å–ª—É–≥–∏
    keyboard = []
    row = []
    for service_id, service in SERVICES.items():
        button = InlineKeyboardButton(
            service["name"], 
            callback_data=f"service_{service_id}"
        )
        row.append(button)
        if len(row) == 2:
            keyboard.append(row)
            row = []
    if row:
        keyboard.append(row)
    
    keyboard.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_menu")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        "üé® *–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É:*\n\n" +
        "\n".join([f"‚Ä¢ {s['name']} ({s['price']})" for s in SERVICES.values()]),
        reply_markup=reply_markup,
        parse_mode=ParseMode.MARKDOWN
    )
    
    return SELECT_SERVICE

async def select_service(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í—ã–±–æ—Ä —É—Å–ª—É–≥–∏"""
    query = update.callback_query
    await query.answer()
    
    service_id = query.data.replace("service_", "")
    service = SERVICES[service_id]
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —É—Å–ª—É–≥—É
    context.user_data["service"] = service
    context.user_data["service_id"] = service_id
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –¥–∞—Ç—ã
    keyboard = []
    today = datetime.now()
    
    # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –Ω–∞ 14 –¥–Ω–µ–π –≤–ø–µ—Ä–µ–¥
    for i in range(14):
        date = today + timedelta(days=i)
        date_str = date.strftime("%d.%m.%Y")
        weekday = date.strftime("%a")
        
        button = InlineKeyboardButton(
            f"{date_str} ({weekday})", 
            callback_data=f"date_{date.strftime('%Y-%m-%d')}"
        )
        keyboard.append([button])
    
    keyboard.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_services")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        f"üìÖ *–í—ã–±—Ä–∞–Ω–æ:* {service['name']}\n\n"
        f"*–¶–µ–Ω–∞:* {service['price']}\n"
        f"*–í—Ä–µ–º—è:* {service['duration']}\n"
        f"*–û–ø–∏—Å–∞–Ω–∏–µ:* {service['description']}\n\n"
        "*–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É:*",
        reply_markup=reply_markup,
        parse_mode=ParseMode.MARKDOWN
    )
    
    return SELECT_DATE

async def select_date(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í—ã–±–æ—Ä –¥–∞—Ç—ã"""
    query = update.callback_query
    await query.answer()
    
    date_str = query.data.replace("date_", "")
    context.user_data["date"] = date_str
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏
    keyboard = []
    row = []
    for time in TIME_SLOTS:
        button = InlineKeyboardButton(time, callback_data=f"time_{time}")
        row.append(button)
        if len(row) == 4:
            keyboard.append(row)
            row = []
    if row:
        keyboard.append(row)
    
    keyboard.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_services")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
    date_obj = datetime.strptime(date_str, "%Y-%m-%d")
    formatted_date = date_obj.strftime("%d.%m.%Y (%A)")
    
    await query.edit_message_text(
        f"üìÖ *–î–∞—Ç–∞:* {formatted_date}\n\n"
        "*–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è:*",
        reply_markup=reply_markup,
        parse_mode=ParseMode.MARKDOWN
    )
    
    return SELECT_TIME

async def select_time(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏"""
    query = update.callback_query
    await query.answer()
    
    time = query.data.replace("time_", "")
    context.user_data["time"] = time
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user = update.effective_user
    if user.first_name:
        context.user_data["name"] = user.first_name
        if user.last_name:
            context.user_data["name"] += f" {user.last_name}"
    
    await query.edit_message_text(
        f"‚è∞ *–í—Ä–µ–º—è:* {time}\n\n"
        "üìù *–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:*\n"
        "(–ú–æ–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –Ω–æ–≤–æ–µ –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ)",
        parse_mode=ParseMode.MARKDOWN
    )
    
    return ENTER_NAME

async def enter_name(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í–≤–æ–¥ –∏–º–µ–Ω–∏"""
    name = update.message.text.strip()
    context.user_data["name"] = name
    
    # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º
    keyboard = [[
        KeyboardButton("üì± –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º", request_contact=True)
    ]]
    reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True, one_time_keyboard=True)
    
    await update.message.reply_text(
        f"üë§ *–ò–º—è:* {name}\n\n"
        "*–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:*\n"
        "(–ò–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ)",
        reply_markup=reply_markup,
        parse_mode=ParseMode.MARKDOWN
    )
    
    return ENTER_PHONE

async def enter_phone(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í–≤–æ–¥ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
    if update.message.contact:
        phone = update.message.contact.phone_number
    else:
        phone = update.message.text.strip()
    
    context.user_data["phone"] = phone
    
    # –£–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    await update.message.reply_text(
        f"üì± *–¢–µ–ª–µ—Ñ–æ–Ω:* {phone}\n\n"
        "üí¨ *–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–ø–∏—Å–∏:*\n"
        "(–ú–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å, –æ—Ç–ø—Ä–∞–≤–∏–≤ /skip)\n\n"
        "–ü—Ä–∏–º–µ—Ä: –∞–ª–ª–µ—Ä–≥–∏—è –Ω–∞ —Ü–∏—Ç—Ä—É—Å–æ–≤—ã–µ, –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω—ã–π –º–∞—Å—Ç–µ—Ä –∏ —Ç.–¥.",
        parse_mode=ParseMode.MARKDOWN,
        reply_markup=ReplyKeyboardMarkup([[]], resize_keyboard=True)  # –£–±–∏—Ä–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    )
    
    return ENTER_COMMENT

async def enter_comment(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í–≤–æ–¥ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è"""
    if update.message.text and update.message.text != "/skip":
        context.user_data["comment"] = update.message.text
    else:
        context.user_data["comment"] = "–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤"
    
    return await show_confirmation(update, context)

async def show_confirmation(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏"""
    data = context.user_data
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
    date_obj = datetime.strptime(data["date"], "%Y-%m-%d")
    formatted_date = date_obj.strftime("%d.%m.%Y (%A)")
    
    confirmation_text = f"""
‚úÖ *–ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ó–ê–ü–ò–°–ò*

*–£—Å–ª—É–≥–∞:* {data['service']['name']}
*–î–∞—Ç–∞:* {formatted_date}
*–í—Ä–µ–º—è:* {data['time']}
*–ò–º—è:* {data['name']}
*–¢–µ–ª–µ—Ñ–æ–Ω:* {data['phone']}
*–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:* {data['comment']}

*–¶–µ–Ω–∞:* {data['service']['price']}
*–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:* {data['service']['duration']}

–í—Å—ë –≤–µ—Ä–Ω–æ?"""
    
    keyboard = [
        [InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–ø–∏—Å—å", callback_data="confirm_appointment")],
        [InlineKeyboardButton("‚úèÔ∏è –ò—Å–ø—Ä–∞–≤–∏—Ç—å", callback_data="edit_appointment")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="cancel")]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if update.callback_query:
        await update.callback_query.edit_message_text(
            confirmation_text,
            reply_markup=reply_markup,
            parse_mode=ParseMode.MARKDOWN
        )
    else:
        await update.message.reply_text(
            confirmation_text,
            reply_markup=reply_markup,
            parse_mode=ParseMode.MARKDOWN
        )
    
    return CONFIRMATION

async def confirm_appointment(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏"""
    query = update.callback_query
    await query.answer()
    
    data = context.user_data
    user = update.effective_user
    
    # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å
    appointment = {
        "user_id": str(user.id),
        "user_username": user.username,
        "service": data["service"]["name"],
        "service_id": data["service_id"],
        "date": data["date"],
        "time": data["time"],
        "name": data["name"],
        "phone": data["phone"],
        "comment": data["comment"],
        "price": data["service"]["price"],
        "duration": data["service"]["duration"]
    }
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–ø–∏—Å—å
    appointment_id = add_appointment(appointment)
    
    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
    date_obj = datetime.strptime(data["date"], "%Y-%m-%d")
    formatted_date = date_obj.strftime("%d.%m.%Y")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
    await query.edit_message_text(
        f"""
üéâ *–ó–ê–ü–ò–°–¨ –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê!* üéâ

*–ù–æ–º–µ—Ä –∑–∞–ø–∏—Å–∏:* #{appointment_id}
*–£—Å–ª—É–≥–∞:* {data['service']['name']}
*–î–∞—Ç–∞:* {formatted_date}
*–í—Ä–µ–º—è:* {data['time']}
*–ú–∞—Å—Ç–µ—Ä:* –±—É–¥–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω

*–ù–∞—à –∞–¥—Ä–µ—Å:* —É–ª. –ö—Ä–∞—Å–æ—Ç—ã, 15
*–¢–µ–ª–µ—Ñ–æ–Ω:* +7 (999) 123-45-67

‚ö†Ô∏è *–ü–æ–∂–∞–ª—É–π—Å—Ç–∞:*
‚Ä¢ –ü—Ä–∏—Ö–æ–¥–∏—Ç–µ –∑–∞ 5-10 –º–∏–Ω—É—Ç –¥–æ –∑–∞–ø–∏—Å–∏
‚Ä¢ –°–æ–æ–±—â–∏—Ç–µ –æ–± –æ—Ç–º–µ–Ω–µ –º–∏–Ω–∏–º—É–º –∑–∞ 3 —á–∞—Å–∞
‚Ä¢ –í–æ–∑—å–º–∏—Ç–µ —Å —Å–æ–±–æ–π –º–∞—Å–∫—É""",
        parse_mode=ParseMode.MARKDOWN
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
    for admin_id in ADMIN_IDS:
        try:
            await context.bot.send_message(
                chat_id=admin_id,
                text=f"""
üìã *–ù–û–í–ê–Ø –ó–ê–ü–ò–°–¨* #{appointment_id}

*–ö–ª–∏–µ–Ω—Ç:* {data['name']}
*–¢–µ–ª–µ—Ñ–æ–Ω:* {data['phone']}
*–£—Å–ª—É–≥–∞:* {data['service']['name']}
*–î–∞—Ç–∞:* {formatted_date}
*–í—Ä–µ–º—è:* {data['time']}
*–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:* {data['comment']}

*ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:* {user.id}
*Username:* @{user.username if user.username else '–Ω–µ—Ç'}""",
                parse_mode=ParseMode.MARKDOWN
            )
        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É {admin_id}: {e}")
    
    # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    context.user_data.clear()
    
    return ConversationHandler.END

async def my_appointments(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç—å –º–æ–∏ –∑–∞–ø–∏—Å–∏"""
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    appointments = get_user_appointments(user_id)
    
    if not appointments:
        await query.edit_message_text(
            "üì≠ –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.",
            parse_mode=ParseMode.MARKDOWN
        )
        return ConversationHandler.END
    
    text = "üìã *–í–ê–®–ò –ó–ê–ü–ò–°–ò:*\n\n"
    
    for app_id, appointment in appointments:
        if appointment.get("status") != "active":
            continue
            
        date_obj = datetime.strptime(appointment["date"], "%Y-%m-%d")
        formatted_date = date_obj.strftime("%d.%m.%Y")
        
        text += f"""
*–ó–∞–ø–∏—Å—å #{app_id}*
{appointment['service']}
*–î–∞—Ç–∞:* {formatted_date}
*–í—Ä–µ–º—è:* {appointment['time']}
*–°—Ç–∞—Ç—É—Å:* {appointment.get('status', 'active')}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
"""
    
    keyboard = [
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å", callback_data="cancel_appointment_list")],
        [InlineKeyboardButton("üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_menu")]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        text,
        reply_markup=reply_markup,
        parse_mode=ParseMode.MARKDOWN
    )
    
    return ConversationHandler.END

async def cancel_appointment_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ú–µ–Ω—é –æ—Ç–º–µ–Ω—ã –∑–∞–ø–∏—Å–∏"""
    query = update.callback_query
    await query.answer()
    
    user_id = update.effective_user.id
    appointments = get_user_appointments(user_id)
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø–∏—Å–∏
    active_appointments = [
        (app_id, app) for app_id, app in appointments 
        if app.get("status") == "active"
    ]
    
    if not active_appointments:
        await query.edit_message_text(
            "üì≠ –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è –æ—Ç–º–µ–Ω—ã.",
            parse_mode=ParseMode.MARKDOWN
        )
        return ConversationHandler.END
    
    keyboard = []
    for app_id, appointment in active_appointments:
        date_obj = datetime.strptime(appointment["date"], "%Y-%m-%d")
        formatted_date = date_obj.strftime("%d.%m")
        
        button_text = f"#{app_id} - {appointment['service']} {formatted_date} {appointment['time']}"
        callback_data = f"cancel_{app_id}"
        
        keyboard.append([InlineKeyboardButton(button_text, callback_data=callback_data)])
    
    keyboard.append([InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="back_to_menu")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        "‚ùå *–í–´–ë–ï–†–ò–¢–ï –ó–ê–ü–ò–°–¨ –î–õ–Ø –û–¢–ú–ï–ù–´:*",
        reply_markup=reply_markup,
        parse_mode=ParseMode.MARKDOWN
    )
    
    return CANCEL_APPOINTMENT

async def cancel_appointment_action(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–º–µ–Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏"""
    query = update.callback_query
    await query.answer()
    
    appointment_id = int(query.data.replace("cancel_", ""))
    appointment = get_appointment(appointment_id)
    
    if not appointment:
        await query.edit_message_text(
            "‚ö†Ô∏è –ó–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.",
            parse_mode=ParseMode.MARKDOWN
        )
        return ConversationHandler.END
    
    # –û—Ç–º–µ–Ω—è–µ–º –∑–∞–ø–∏—Å—å
    success = cancel_appointment(appointment_id, cancelled_by="client")
    
    if success:
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞
        await query.edit_message_text(
            f"‚úÖ *–ó–∞–ø–∏—Å—å #{appointment_id} –æ—Ç–º–µ–Ω–µ–Ω–∞.*\n\n"
            f"–ú—ã –±—É–¥–µ–º —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å —Å–Ω–æ–≤–∞!",
            parse_mode=ParseMode.MARKDOWN
        )
        
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        for admin_id in ADMIN_IDS:
            try:
                await context.bot.send_message(
                    chat_id=admin_id,
                    text=f"""
‚ùå *–û–¢–ú–ï–ù–ê –ó–ê–ü–ò–°–ò* #{appointment_id}

*–ö–ª–∏–µ–Ω—Ç:* {appointment['name']}
*–¢–µ–ª–µ—Ñ–æ–Ω:* {appointment['phone']}
*–£—Å–ª—É–≥–∞:* {appointment['service']}
*–î–∞—Ç–∞:* {appointment['date']}
*–í—Ä–µ–º—è:* {appointment['time']}

*–û—Ç–º–µ–Ω–µ–Ω–æ:* –∫–ª–∏–µ–Ω—Ç–æ–º""",
                    parse_mode=ParseMode.MARKDOWN
                )
            except Exception as e:
                logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É {admin_id}: {e}")
    else:
        await query.edit_message_text(
            "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            parse_mode=ParseMode.MARKDOWN
        )
    
    return ConversationHandler.END

# ========== –ê–î–ú–ò–ù-–§–£–ù–ö–¶–ò–ò ==========
async def admin_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    if user.id not in ADMIN_IDS:
        await query.edit_message_text("‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.")
        return ConversationHandler.END
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏
    data = load_appointments()
    appointments = data["appointments"]
    
    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    total = len(appointments)
    active = sum(1 for a in appointments.values() if a.get("status") == "active")
    cancelled = sum(1 for a in appointments.values() if a.get("status") == "cancelled")
    
    keyboard = [
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats")],
        [InlineKeyboardButton("üìã –í—Å–µ –∑–∞–ø–∏—Å–∏", callback_data="admin_all_appointments")],
        [InlineKeyboardButton("üìÖ –ó–∞–ø–∏—Å–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è", callback_data="admin_today")],
        [InlineKeyboardButton("üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –∫–ª–∏–µ–Ω—Ç–æ–≤", callback_data="admin_contacts")],
        [InlineKeyboardButton("üîô –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="back_to_menu")]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        f"üëë *–ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨*\n\n"
        f"*–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π:* {total}\n"
        f"*–ê–∫—Ç–∏–≤–Ω—ã—Ö:* {active}\n"
        f"*–û—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö:* {cancelled}",
        reply_markup=reply_markup,
        parse_mode=ParseMode.MARKDOWN
    )
    
    return ConversationHandler.END

async def admin_all_appointments(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í—Å–µ –∑–∞–ø–∏—Å–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    query = update.callback_query
    await query.answer()
    
    user = update.effective_user
    if user.id not in ADMIN_IDS:
        return
    
    data = load_appointments()
    appointments = data["appointments"]
    
    if not appointments:
        await query.edit_message_text("üì≠ –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π.")
        return
    
    text = "üìã *–í–°–ï –ó–ê–ü–ò–°–ò:*\n\n"
    
    for app_id, appointment in sorted(appointments.items(), key=lambda x: x[1].get("date", "")):
        status = appointment.get("status", "active")
        status_icon = "‚úÖ" if status == "active" else "‚ùå" if status == "cancelled" else "üìù"
        
        date_obj = datetime.strptime(appointment["date"], "%Y-%m-%d")
        formatted_date = date_obj.strftime("%d.%m.%Y")
        
        text += f"""
{status_icon} *–ó–∞–ø–∏—Å—å #{app_id}*
{appointment['service']}
*–ö–ª–∏–µ–Ω—Ç:* {appointment['name']}
*–¢–µ–ª–µ—Ñ–æ–Ω:* {appointment['phone']}
*–î–∞—Ç–∞:* {formatted_date} {appointment['time']}
*–°—Ç–∞—Ç—É—Å:* {status}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
"""
    
    keyboard = [
        [InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="admin_all_appointments")],
        [InlineKeyboardButton("üîô –í –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_panel")]
    ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(
        text[:4000],  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Telegram
        reply_markup=reply_markup,
        parse_mode=ParseMode.MARKDOWN
    )

async def admin_cancel_appointment(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–º–µ–Ω–∞ –∑–∞–ø–∏—Å–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"""
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ—Ç–º–µ–Ω—ã –∑–∞–ø–∏—Å–µ–π –∞–¥–º–∏–Ω–æ–º
    # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –æ—Ç–º–µ–Ω–µ –∫–ª–∏–µ–Ω—Ç–æ–º, –Ω–æ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ–º –∫–ª–∏–µ–Ω—Ç—É
    pass

# ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
async def back_to_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"""
    query = update.callback_query
    await query.answer()
    
    return await start(update, context)

async def back_to_services(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–í–æ–∑–≤—Ä–∞—Ç –∫ –≤—ã–±–æ—Ä—É —É—Å–ª—É–≥–∏"""
    query = update.callback_query
    await query.answer()
    
    return await new_appointment(update, context)

async def contacts(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ö–æ–Ω—Ç–∞–∫—Ç—ã —Å–∞–ª–æ–Ω–∞"""
    query = update.callback_query
    await query.answer()
    
    await query.edit_message_text(
        """
üìû *–ö–û–ù–¢–ê–ö–¢–´ –°–ê–õ–û–ù–ê*

*–ê–¥—Ä–µ—Å:* —É–ª. –ö—Ä–∞—Å–æ—Ç—ã, 15
*–¢–µ–ª–µ—Ñ–æ–Ω:* +7 (999) 123-45-67
*Email:* info@beautyelegance.ru
*Instagram:* @beautyelegance

*–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:*
–ü–Ω-–ü—Ç: 9:00 - 21:00
–°–±-–í—Å: 10:00 - 20:00

*–ö–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è:* –º–µ—Ç—Ä–æ "–ö—Ä–∞—Å–∏–≤–∞—è", 5 –º–∏–Ω—É—Ç –ø–µ—à–∫–æ–º""",
        parse_mode=ParseMode.MARKDOWN
    )
    
    return ConversationHandler.END

async def about(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û —Å–∞–ª–æ–Ω–µ"""
    query = update.callback_query
    await query.answer()
    
    await query.edit_message_text(
        """
üè© *BEAUTY ELEGANCE*

*–ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–π —Å–∞–ª–æ–Ω –∫—Ä–∞—Å–æ—Ç—ã –≤ —Ü–µ–Ω—Ç—Ä–µ –≥–æ—Ä–æ–¥–∞*

–ú—ã —Ä–∞–±–æ—Ç–∞–µ–º —Å 2015 –≥–æ–¥–∞ –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º:
‚Ä¢ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—É—é –∫–æ—Å–º–µ—Ç–∏–∫—É
‚Ä¢ –û–ø—ã—Ç–Ω—ã—Ö –º–∞—Å—Ç–µ—Ä–æ–≤
‚Ä¢ –£—é—Ç–Ω—É—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É

*–ù–∞—à–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:*
‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è
‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—è –Ω–∞ –≤—Å–µ —É—Å–ª—É–≥–∏
‚úÖ –ü–æ–¥–∞—Ä–æ—á–Ω—ã–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
‚úÖ –°–∏—Å—Ç–µ–º–∞ –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏

*–ù–∞—à–∏ –º–∞—Å—Ç–µ—Ä–∞* ‚Äî –¥–∏–ø–ª–æ–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã —Å –æ–ø—ã—Ç–æ–º —Ä–∞–±–æ—Ç—ã –æ—Ç 5 –ª–µ—Ç.""",
        parse_mode=ParseMode.MARKDOWN
    )
    
    return ConversationHandler.END

async def cancel_conversation(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û—Ç–º–µ–Ω–∞ –¥–∏–∞–ª–æ–≥–∞"""
    await update.message.reply_text(
        "–ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞. –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ, –Ω–∞–∂–º–∏—Ç–µ /start",
        reply_markup=ReplyKeyboardMarkup([[]], resize_keyboard=True)
    )
    
    context.user_data.clear()
    return ConversationHandler.END

# ========== –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ==========
def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
    # –°–æ–∑–¥–∞–µ–º Application
    application = Application.builder().token(TOKEN).build()
    
    # –°–æ–∑–¥–∞–µ–º ConversationHandler –¥–ª—è –∑–∞–ø–∏—Å–∏
    conv_handler = ConversationHandler(
        entry_points=[
            CallbackQueryHandler(new_appointment, pattern="^new_appointment$")
        ],
        states={
            SELECT_SERVICE: [
                CallbackQueryHandler(select_service, pattern="^service_"),
                CallbackQueryHandler(back_to_menu, pattern="^back_to_menu$")
            ],
            SELECT_DATE: [
                CallbackQueryHandler(select_date, pattern="^date_"),
                CallbackQueryHandler(back_to_services, pattern="^back_to_services$")
            ],
            SELECT_TIME: [
                CallbackQueryHandler(select_time, pattern="^time_"),
                CallbackQueryHandler(back_to_services, pattern="^back_to_services$")
            ],
            ENTER_NAME: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, enter_name)
            ],
            ENTER_PHONE: [
                MessageHandler(filters.CONTACT | filters.TEXT, enter_phone)
            ],
            ENTER_COMMENT: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, enter_comment),
                CommandHandler("skip", enter_comment)
            ],
            CONFIRMATION: [
                CallbackQueryHandler(confirm_appointment, pattern="^confirm_appointment$"),
                CallbackQueryHandler(new_appointment, pattern="^edit_appointment$"),
                CallbackQueryHandler(cancel_conversation, pattern="^cancel$")
            ],
            CANCEL_APPOINTMENT: [
                CallbackQueryHandler(cancel_appointment_action, pattern="^cancel_"),
                CallbackQueryHandler(back_to_menu, pattern="^back_to_menu$")
            ]
        },
        fallbacks=[
            CommandHandler("cancel", cancel_conversation),
            CommandHandler("start", start)
        ],
        allow_reentry=True
    )
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    application.add_handler(CommandHandler("start", start))
    application.add_handler(conv_handler)
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback-–∑–∞–ø—Ä–æ—Å–æ–≤
    application.add_handler(CallbackQueryHandler(my_appointments, pattern="^my_appointments$"))
    application.add_handler(CallbackQueryHandler(cancel_appointment_menu, pattern="^cancel_appointment$"))
    application.add_handler(CallbackQueryHandler(cancel_appointment_action, pattern="^cancel_appointment_list$"))
    application.add_handler(CallbackQueryHandler(contacts, pattern="^contacts$"))
    application.add_handler(CallbackQueryHandler(about, pattern="^about$"))
    application.add_handler(CallbackQueryHandler(admin_panel, pattern="^admin_panel$"))
    application.add_handler(CallbackQueryHandler(admin_all_appointments, pattern="^admin_all_appointments$"))
    application.add_handler(CallbackQueryHandler(back_to_menu, pattern="^back_to_menu$"))
    application.add_handler(CallbackQueryHandler(back_to_services, pattern="^back_to_services$"))
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω! –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()
worker: python bot.py
python-telegram-bot==20.3
python-dotenv==1.0.0
